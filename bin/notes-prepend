#!/bin/zsh

# Validate target file
# ------------------------------------------------
local _target=$1

if [[ -z $_target ]] ; then
  echo "fatal: Did not pass a target file to prepend."
  exit 1
fi

if [[ ! -f $_target ]] ; then
  echo "fatal: The target '$_target' is not a file."
  exit 1
fi

if [[ ! -w $_target ]] ; then
  echo "fatal: The target file '$_target' is not a writable file."
  exit 1
fi

shift

# Validate string to prepend argument
# ------------------------------------------------
local _to_prepend="$*"

if [[ -z $_to_prepend ]] ; then
  echo "fatal: You did not pass anything to prepend."
  exit 1
fi

# Create the temporary file with mktemp
# ------------------------------------------------
local _basename=`basename $0`
local _temporary_file_path=`mktemp "/tmp/$_basename.XXXX"`

if [[ $? != 0 ]] ; then
  echo "fatal: Could not create temporary file in '/tmp'."
  exit 1
fi

# Prepend/merge to the temporary file
# ------------------------------------------------
if ! ( echo $_to_prepend >> $_temporary_file_path && cat $_target >> $_temporary_file_path ) ; then
  echo "fatal: Could not prepend the inputs to the temporary file at '$_temporary_file_path'."
  exit 1
fi

# Overwrite the original target
# ------------------------------------------------
if ! mv $_temporary_file_path $_target ; then
  echo "fatal: Could not move/overwrite the original target file at '$_target' with the temporary file at '$_temporary_file_path'."
  exit 1
fi

